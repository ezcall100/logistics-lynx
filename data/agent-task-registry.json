{
  "version": "2.0.0",
  "last_updated": "2024-12-01T00:00:00.000Z",
  "platform": "transbot-ai",
  "operating_mode": "autonomous-24-7",
  "standing_order": "A-1",
  "golden_rules": {
    "flags_first": {
      "hierarchy": "global → env → tenant",
      "blocked_action": "no-op + FF_BLOCKED log",
      "never_bypass": true
    },
    "identity_scope": {
      "jwt_required": "role-based",
      "hmac_v2": "timestamp+nonce",
      "company_id": "all reads/writes"
    },
    "idempotency": {
      "check_before_external": "event/outbox keys",
      "dedupe": ["stripe", "edi_webhooks"],
      "window": "10-min"
    },
    "rls_safe": {
      "never_bypass": "outside service-role edge paths",
      "company_scoped": "all operations",
      "audit_trail": "all changes"
    },
    "durability": {
      "pattern": "write → commit → publish via Outbox",
      "failure": "DLQ (auto-snooze/backoff)",
      "circuit_break": "≥20% immediate fails"
    },
    "observability": {
      "root_span": "agent.task.execute",
      "function_spans": "agent.fn.<domain>.<action>",
      "error_recording": "with context",
      "trace_links": "in Slack"
    },
    "slo_gates": {
      "uptime": "≥99.95%",
      "success_rate": "≥98%",
      "p95_latency": "≤2.5s",
      "quarantine_rate": "<1%",
      "breach_action": "throttle, open incident, flip canaries off"
    }
  },
  "end_to_end_flows": [
    {
      "id": "quote_to_bill",
      "name": "Quote → Book → Bill",
      "start": ["roi_form", "broker_request", "api_edi_204"],
      "do": [
        "normalize",
        "price (rates.price_one)",
        "offer_tender (204)",
        "book (990 ack)",
        "track (214)",
        "pod_ocr",
        "invoice (210)",
        "ar_factoring"
      ],
      "finish": {
        "load": "closed",
        "invoice": "paid",
        "analytics": "written"
      },
      "fail": "DLQ + backoff; circuit-break lane if ≥20% immediate fails"
    },
    {
      "id": "carrier_onboard",
      "name": "Carrier Onboard → Live",
      "start": ["application", "kyc"],
      "do": [
        "docs_verify",
        "compliance_score",
        "integrations",
        "trial_load"
      ],
      "finish": {
        "carrier": "active",
        "lanes": "enabled"
      }
    },
    {
      "id": "exception_remediate",
      "name": "Exception → Auto-Remediate",
      "start": ["sla_anomaly", "eta_anomaly"],
      "do": [
        "classify",
        "re_tender",
        "re_route",
        "re_price",
        "notify"
      ],
      "finish": {
        "exception_resolution": "success",
        "fallback": "quarantine + alert"
      }
    },
    {
      "id": "dr_failover",
      "name": "DR / Multi-Region",
      "start": "health_gate_fail_3x_30s",
      "do": [
        "flip_region_flag",
        "drain",
        "replay_outbox"
      ],
      "finish": {
        "secondary": "green",
        "incident": "posted"
      }
    }
  ],
  "portal_tasks": {
    "super_admin": {
      "start": "config_change",
      "do": ["companies", "flags", "audit"],
      "finish": "change audited + propagated"
    },
    "admin": {
      "start": "invite_role_key",
      "do": ["profiles", "roles", "api_keys"],
      "finish": "auth passes, keys rotated"
    },
    "tms_admin": {
      "start": "lane_contract_guardrail",
      "do": ["lanes", "contracts", "pricing_guards"],
      "finish": "guardrails enforced"
    },
    "onboarding": {
      "start": "step_submit_import",
      "do": ["onboarding_steps", "connect"],
      "finish": "onboarding.complete=true"
    },
    "broker": {
      "start": "quote_tender_book",
      "do": ["quotes", "loads", "docs", "edi"],
      "finish": "booked + invoiced"
    },
    "shipper": {
      "start": "self_serve_quote_order",
      "do": ["shipper_orders", "tracking"],
      "finish": "delivered + paid"
    },
    "carrier": {
      "start": "bid_accept_capacity",
      "do": ["carrier_bids", "capacity", "coi"],
      "finish": "award + on-time delivery"
    },
    "driver": {
      "start": "stop_pod_status",
      "do": ["stop_events", "pod_docs"],
      "finish": "signed POD accepted"
    },
    "owner_operator": {
      "start": "revenue_costs",
      "do": ["settlements", "fleet_costs"],
      "finish": "weekly payout cleared"
    },
    "factoring": {
      "start": "package_submit",
      "do": ["factoring_submissions", "ar_status"],
      "finish": "funded + reconciled"
    },
    "load_board": {
      "start": "post_bid_award",
      "do": ["market_posts", "bids"],
      "finish": "fill rate ≥ target"
    },
    "crm": {
      "start": "account_opp_activity",
      "do": ["accounts", "opportunities"],
      "finish": "win/lose updated"
    },
    "financials": {
      "start": "invoice_ap_gl",
      "do": ["invoices", "ap", "gl_events"],
      "finish": "DSO within target; payouts on time"
    },
    "edi": {
      "start": "204_990_214_210",
      "do": ["edi_messages", "ack_chain"],
      "finish": "no NAKs outstanding"
    },
    "marketplace": {
      "start": "install_webhook",
      "do": ["installations", "webhooks"],
      "finish": "healthy app checks"
    },
    "analytics": {
      "start": "refresh_views",
      "do": "read_materialized_views",
      "finish": "KPIs green or open ticket"
    },
    "autonomous": {
      "start": "queue_dlq_quarantine",
      "do": ["agent_tasks", "agent_logs", "dlq_*"],
      "finish": "success ≥98%, quarantine <1%"
    },
    "workers": {
      "start": "schedule_assign",
      "do": ["work_shifts", "work_assignments"],
      "finish": "backlog under threshold"
    },
    "rates": {
      "start": "instant_price_contract_index",
      "do": ["rate_cards", "indices"],
      "finish": "guardrails OK, margin ok"
    },
    "directory": {
      "start": "verify_kyc_safety",
      "do": ["partners", "verifications"],
      "finish": "partner usable"
    },
    "testing": {
      "start": "test_validate_verify",
      "do": ["test_results", "test_metrics"],
      "finish": "tests pass, coverage maintained"
    }
  },
  "website_events": {
    "conversion_critical": {
      "/roi": {
        "event": "lead.roi_submitted",
        "flow": "score → n8n route → trial/checkout link"
      },
      "/trial": {
        "event": "stripe_entitlements",
        "flow": "Stripe → entitlements → flags on"
      },
      "/checkout": {
        "event": "stripe_session",
        "flow": "session → webhook → plan set"
      },
      "/contact": {
        "event": "lead.contact",
        "flow": "CRM + Slack"
      },
      "/demo": {
        "event": "lead.demo",
        "flow": "CRM + Slack"
      }
    },
    "hubs_content": {
      "features_solutions_resources": {
        "event": "content.view",
        "flow": "UTM enrich → CRM timeline → nurture automations"
      },
      "/resources/api/*": {
        "event": "dev.intent",
        "flow": "open API key draft (flag-gated)"
      }
    },
    "all_pages": {
      "csp": "respect",
      "pii": "no logs",
      "events": "Outbox → n8n for downstream"
    }
  },
  "schedules": {
    "30s": [
      "health_probe",
      "queue_depth",
      "slo_check",
      "throttle_if_breach"
    ],
    "5m": [
      "dlq_retry",
      "max_items": 50,
      "max_size": "2MB",
      "stop_if": ">20% immediate fails"
    ],
    "hourly": [
      "guardrail_drift",
      "index_refresh",
      "etl_ticks"
    ],
    "daily_03_00": [
      "partitions_rotate",
      "ttl_cleanup_30d",
      "budget_reset"
    ],
    "weekly": [
      "dr_drill_dry_run",
      "security_scans",
      "portal_410_drift_audit"
    ],
    "monthly": [
      "restore_test",
      "flag_hygiene",
      "cost_review"
    ]
  },
  "alerts": {
    "page": [
      "outbox_lag_p95_5s_15m",
      "dlq_replay_fail_40_percent",
      "success_95_percent",
      "checkout_error_surge",
      "edi_nak_storm"
    ],
    "warn": [
      "410_hits_50_per_hr_tenant",
      "contract_guardrail_violations",
      "tracking_gaps"
    ],
    "info": [
      "flag_changes",
      "plan_changes",
      "dr_drill_pass"
    ]
  },
  "safety_budgets": {
    "per_tenant": {
      "replays": "enforced via flags",
      "expensive_ops": "enforced via flags"
    },
    "rate_limits": {
      "roi": "10/min",
      "checkout": "5/min",
      "dlq_replay": "3/5m (tenant+IP)"
    },
    "replay_requirements": {
      "v2_signature": true,
      "nonce": true,
      "idempotency_window": "10-min"
    }
  },
  "incident_automations": {
    "slo_breach": [
      "halve_concurrency",
      "disable_canaries",
      "open_incident",
      "attach_runbook_trace_link"
    ],
    "partner_down": [
      "circuit_break",
      "queue_locally",
      "escalate_after_15m"
    ],
    "data_drift": [
      "revert_flag_set",
      "quarantine_new_writes",
      "page_owner"
    ]
  },
  "done_invariants": {
    "every_business_flow": [
      "correct_ledger_entries",
      "audit_log_written",
      "spans_closed_with_status",
      "analytics_updated"
    ],
    "every_external_call": [
      "originates_from_outbox_entry",
      "has_idempotency",
      "either_ack_or_dlq_record"
    ],
    "every_error": [
      "has_trace_link",
      "redacted_context",
      "retry_or_quarantine_disposition"
    ]
  },
  "success_metrics": {
    "operational_excellence": {
      "uptime": "≥99.95%",
      "success_rate": "≥98%",
      "p95_latency": "≤2.5s",
      "quarantine_rate": "<1%"
    },
    "business_metrics": {
      "quote_to_book": "≥85%",
      "on_time_delivery": "≥95%",
      "invoice_accuracy": "≥99%",
      "customer_satisfaction": "≥4.5/5"
    }
  }
}
