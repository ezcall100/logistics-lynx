# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
# yaml-language-server: disableContextAccess: true
# yaml-language-server: disableDefaultProperties: true
# yaml-language-server: disableAdditionalProperties: true
# yaml-language-server: validate: false
# yaml-language-server: disableSchemaValidation: true
name: CodeQL

on:
  schedule:
    - cron: '0 6 * * 1'  # Every Monday at 6 AM UTC
  workflow_dispatch:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

permissions:
  contents: read
  actions: read
  security-events: write

env:
  # Vars (environment-scoped or repository vars)
  ENVIRONMENT_NAME: ${{ vars.ENVIRONMENT_NAME || 'development' }}
  APP_URL: ${{ vars.APP_URL || 'http://localhost' }}

  # Secrets (if any are needed for CodeQL)
  SUPABASE_URL: ${{ secrets.SUPABASE_URL || '' }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || '' }}

jobs:
  codeql:
    name: CodeQL / Analyze
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Detect languages present (js/ts onlyâ€”add more if needed)
      - name: Detect languages
        id: langs
        shell: bash
        run: |
          set -euo pipefail
          L=""
          if git ls-files '*.js' '*.jsx' '*.ts' '*.tsx' >/dev/null 2>&1; then L="javascript"; fi
          if [ -z "$L" ]; then
            echo "::warning title=CodeQL skipped::No JS/TS files detected."
            echo "has_lang=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_lang=true" >> "$GITHUB_OUTPUT"
            echo "langs=$L" >> "$GITHUB_OUTPUT"
          fi

      - uses: github/codeql-action/init@v3
        if: ${{ steps.langs.outputs.has_lang == 'true' }}
        with:
          languages: ${{ steps.langs.outputs.langs }}
          queries: +security-and-quality

      - name: Setup Node (for better analysis)
        if: ${{ steps.langs.outputs.has_lang == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install & Build (best effort)
        if: ${{ steps.langs.outputs.has_lang == 'true' }}
        run: |
          npm ci --no-audit --no-fund || true
          npm run build --if-present || true

      - uses: github/codeql-action/analyze@v3
        if: ${{ steps.langs.outputs.has_lang == 'true' }}
        with:
          category: "/language:${{ steps.langs.outputs.langs }}"

      - name: ðŸ“Š Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results-javascript.sarif
