# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
# yaml-language-server: disableContextAccess: true
# yaml-language-server: disableDefaultProperties: true
# yaml-language-server: disableAdditionalProperties: true
# yaml-language-server: validate: false
# yaml-language-server: disableSchemaValidation: true

name: CodeQL

on:
  schedule:
    - cron: '0 6 * * 1' # Every Monday at 6 AM UTC
  workflow_dispatch:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  codeql:
    name: CodeQL / Analyze
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Detect languages (JS/TS covered by "javascript")
      - name: Detect languages
        id: langs
        shell: bash
        run: |
          set -euo pipefail
          if git ls-files '*.js' '*.jsx' '*.ts' '*.tsx' >/dev/null 2>&1; then
            echo "has_lang=true" >> "$GITHUB_OUTPUT"
            echo "langs=javascript" >> "$GITHUB_OUTPUT"
          else
            echo "::warning title=CodeQL skipped::No JS/TS files detected."
            echo "has_lang=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Initialize CodeQL
        if: ${{ steps.langs.outputs.has_lang == 'true' }}
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ steps.langs.outputs.langs }}
          queries: +security-and-quality

      - name: Setup Node (for better analysis)
        if: ${{ steps.langs.outputs.has_lang == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install & Build (best effort)
        if: ${{ steps.langs.outputs.has_lang == 'true' }}
        run: |
          npm ci --no-audit --no-fund || true
          npm run build --if-present || true

      - name: Perform CodeQL Analysis
        if: ${{ steps.langs.outputs.has_lang == 'true' }}
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ steps.langs.outputs.langs }}"
