name: 'n8n-trigger'
description: 'Trigger n8n workflow with retries and health check'
branding:
  icon: 'send'
  color: 'blue'
inputs:
  n8n-base-url:
    description: 'Base URL'
    required: true
  n8n-api-key:
    description: 'API key'
    required: true
  payload:
    description: 'JSON payload'
    required: true
  retries:
    description: 'Retry attempts'
    default: '3'
  delay-seconds:
    description: 'Delay between retries'
    default: '5'
runs:
  using: composite
  steps:
    - shell: bash
      run: |
        set -euo pipefail
        echo "::add-mask::${{ inputs.n8n-api-key }}"
        curl --fail -sS "${{ inputs.n8n-base-url }}/healthz" >/dev/null
        for i in $(seq 1 "${{ inputs.retries }}"); do
          if curl --fail -sS -X POST "${{ inputs.n8n-base-url }}/webhook/deploy" \
            -H "X-N8N-API-KEY: ${{ inputs.n8n-api-key }}" \
            -H "Content-Type: application/json" \
            -d '${{ inputs.payload }}'
          then
            echo "n8n trigger: success"
            exit 0
          fi
          echo "n8n trigger: retry $i/${{ inputs.retries }} in ${{ inputs.delay-seconds }}s..."
          sleep "${{ inputs.delay-seconds }}"
        done
        echo "n8n trigger: failed after retries" >&2
        exit 1
