# Test workflow to validate syntax and environment variable access
name: 🧪 Test Workflow Syntax

on:
  workflow_dispatch:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test-syntax:
    name: 🧪 Test Workflow Syntax
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      # Placeholder values (will be overridden by export script)
      ENVIRONMENT_NAME: 'test'
      APP_URL: 'http://localhost'
      STAGING_URL: 'https://staging.example.com'
      PRODUCTION_URL: 'https://production.example.com'
      N8N_ENABLED: 'false'
      N8N_BASE_URL: 'https://n8n.example.com'
      DEPLOYMENT_WEBHOOK_URL: 'https://deployment.example.com/webhook'
      SUPABASE_URL: 'https://placeholder.supabase.co'
      SUPABASE_ANON_KEY: 'placeholder-key'
      OPENAI_API_KEY: 'placeholder-key'
      N8N_API_KEY: 'placeholder-key'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Export Environment Variables
        run: |
          echo "🔧 Exporting environment variables and secrets..."
          
          # Export vars with fallbacks
          {
            echo "ENVIRONMENT_NAME=${{ vars.ENVIRONMENT_NAME || 'test' }}"
            echo "APP_URL=${{ vars.APP_URL || 'http://localhost' }}"
            echo "STAGING_URL=${{ vars.STAGING_URL || 'https://staging.example.com' }}"
            echo "PRODUCTION_URL=${{ vars.PRODUCTION_URL || 'https://production.example.com' }}"
            echo "N8N_ENABLED=${{ vars.N8N_ENABLED || 'false' }}"
            echo "N8N_BASE_URL=${{ vars.N8N_BASE_URL || 'https://n8n.example.com' }}"
            echo "DEPLOYMENT_WEBHOOK_URL=${{ vars.DEPLOYMENT_WEBHOOK_URL || 'https://deployment.example.com/webhook' }}"
            
            # Export secrets with fallbacks
            echo "SUPABASE_URL=${{ secrets.SUPABASE_URL || 'https://placeholder.supabase.co' }}"
            echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY || 'placeholder-key' }}"
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY || 'placeholder-key' }}"
            echo "N8N_API_KEY=${{ secrets.N8N_API_KEY || 'placeholder-key' }}"
          } >> "$GITHUB_ENV"
          
          echo "✅ Environment variables exported successfully!"
        
      - name: Test environment variable access
        run: |
          echo "🧪 Testing environment variable access..."
          echo "Environment: $ENVIRONMENT_NAME"
          echo "App URL: $APP_URL"
          echo "Staging URL: $STAGING_URL"
          echo "Production URL: $PRODUCTION_URL"
          echo "N8N Enabled: $N8N_ENABLED"
          echo "N8N Base URL: $N8N_BASE_URL"
          echo "Deployment Webhook URL: $DEPLOYMENT_WEBHOOK_URL"
          echo ""
          echo "🔐 Testing secret access (values masked for security)..."
          echo "Supabase URL: ${SUPABASE_URL:0:20}..."
          echo "Supabase Key: ${SUPABASE_ANON_KEY:0:10}..."
          echo "OpenAI Key: ${OPENAI_API_KEY:0:10}..."
          echo "N8N Key: ${N8N_API_KEY:0:10}..."
          echo ""
          echo "✅ All environment variables and secrets are accessible!"
          
      - name: Test conditional logic
        run: |
          echo "🧪 Testing conditional logic..."
          
          if [[ "$ENVIRONMENT_NAME" == "production" ]]; then
            echo "🎯 Production environment detected"
          elif [[ "$ENVIRONMENT_NAME" == "staging" ]]; then
            echo "🎯 Staging environment detected"
          else
            echo "🎯 Test environment detected"
          fi
          
          if [[ "$N8N_ENABLED" == "true" ]]; then
            echo "🔧 N8N integration is enabled"
          else
            echo "🔧 N8N integration is disabled"
          fi
          
      - name: Test workflow context
        run: |
          echo "🧪 Testing workflow context access..."
          echo "Repository: ${{ github.repository }}"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Job: ${{ github.job }}"
          echo "Runner OS: ${{ runner.os }}"
          echo ""
          echo "✅ All context variables are accessible!"
          
      - name: Test outputs
        id: test-outputs
        run: |
          echo "🧪 Testing workflow outputs..."
          echo "test_result=success" >> "$GITHUB_OUTPUT"
          echo "test_timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$GITHUB_OUTPUT"
          echo "test_environment=$ENVIRONMENT_NAME" >> "$GITHUB_OUTPUT"
          echo "✅ Outputs set successfully!"
          
      - name: Display outputs
        run: |
          echo "📋 Workflow outputs:"
          echo "Result: ${{ steps.test-outputs.outputs.test_result }}"
          echo "Timestamp: ${{ steps.test-outputs.outputs.test_timestamp }}"
          echo "Environment: ${{ steps.test-outputs.outputs.test_environment }}"
          
      - name: Success summary
        run: |
          {
            echo "## 🎉 Workflow Syntax Test Results"
            echo ""
            echo "✅ **Status**: All tests passed!"
            echo "🔧 **Environment**: ${{ steps.test-outputs.outputs.test_environment }}"
            echo "📅 **Timestamp**: ${{ steps.test-outputs.outputs.test_timestamp }}"
            echo "🎯 **Result**: ${{ steps.test-outputs.outputs.test_result }}"
            echo ""
            echo "### ✅ What Was Tested:"
            echo "- Environment variable access with fallbacks"
            echo "- Secret access with fallbacks"
            echo "- Conditional logic"
            echo "- Workflow context access"
            echo "- Output generation and consumption"
            echo ""
            echo "### 💡 Conclusion:"
            echo "All GitHub Actions syntax is working correctly!"
            echo "The 'Context access might be invalid' warnings are false positives."
          } >> "$GITHUB_STEP_SUMMARY"
